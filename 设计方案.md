# 脑图产品 — 业务逻辑设计方案
## 一、总体概念与关键实体（逻辑层）

* **User**：用户，含 `id, name, avatar, role`（owner/editor/viewer）、配额/限流信息。
* **Document (MindMap)**：文档层级单元，含 `id, title, ownerId, meta`（主题/模板/skin）、rootNodeId、visibility(私有/共享/公开)，权限表（ACL）。
* **Node**：脑图节点，含 `id, parentId, childrenOrder[]`, `content`, `labels[]`, `color`, `icon`, `description`, `collapsed`（折叠开关）, `position`（用于自由拖拽/布局），`metadata`（AI-generated flags）。
* **Fragment / Chunk**：文档分片（按层级或 subtree 划分），便于分片加载与快照。
* **Session (Realtime)**：实时会话，`docId`, `yjsDocId`, 活跃用户列表，presence 信息（光标/选中节点）。
* **Version / Snapshot**：静态快照，含 `versionId, docId, rootHash, createdBy, timestamp, summary`.
* **Operation (op)**：业务操作记录（增删改查/拖拽/折叠/属性变更等），用于回放、diff、CRDT log。
* **Template**：文档模板（会议、SWOT、产品规划等），含空结构与默认样式与说明。
* **AI Request/Job**：LLM 调用记录，含 `id, userId, docId, nodeId?, promptTemplate, status, costEstimate, resultSummary, validationStatus`.

---

## 二、关键业务用例与流程（每个用例包含触发 → 验证 → 状态变更 → 输出）

### 1. 基本CRUD（节点 & 文档）

* **创建文档**

  * 触发：用户选择“创建”或使用模板。
  * 验证：权限（登录/配额）；模板合法性。
  * 变更：生成 Document + root Node + initial version snapshot。
  * 输出：documentId, initialVersionId。

* **节点新增**

  * 触发：在界面“新增子节点/兄弟节点”或通过拖拽外部导入。
  * 验证：节点内容不为空（可选长度校验）；用户有编辑权限；AI 自动校验禁用词。
  * 变更：创建 Node，append childrenOrder，记录 operation。
  * 输出：新的 nodeId，operationId（用于实时广播/回放）。

* **节点修改（内容/属性）**

  * 触发：编辑文本、改颜色/图标/标签/描述。
  * 验证：权限，数据格式，标签数上限等。
  * 变更：更新 Node 的字段，生成 operation。
  * 输出：operationId，触发版本合并策略（实时小快照或延迟合并）。

* **节点删除 / 批量编辑**

  * 批量编辑（标签/颜色）接受 nodeId[]，事务式申请：要么全部成功要么回滚（业务层保证）。
  * 删除要记录 tombstone（用于 diff / 回滚）。

### 2. 拖拽 / 重排序 / 结构变更

* 拖拽触发结构变更操作（改变 parentId 或 childrenOrder）。
* 验证：防止循环引用、最大深度限制、是否跨文档拖拽允许。
* 变更：生成结构化 operation（oldParent, newParent, oldIndex, newIndex）。
* 输出：operationId，触发自动布局（如选中自动重排）可作为后续异步操作（业务上只需标记需要 layout）。

### 3. 折叠/展开

* 折叠改变 `collapsed` 字段；UI 只需响应该状态。
* 折叠/展开事件记录为轻量 operation，不生成完整快照，便于回放。

---

## 三、实时协作 & 多人 presence（业务语义）

* **实时数据流**：以 operation 为单位发布（增删改/拖拽/折叠等），每个 op 带 `opId, userId, timestamp, opType, payload`。
* **CRDT / 合并语义**（业务层面）

  * 所有编辑最终以 operation log（或 CRDT state）为单一真相。业务需保证操作幂等（基于 opId）。
  * 对于冲突（例如同时编辑同一节点文本），业务采用**最后写入胜出（LWW）**或**基于字段的合并**；关键点是明确：**UI 显示冲突提示或高亮最近修改者**。
* **Presence**

  * presence 包含 `userId, cursorNodeId, selection, lastActiveAt, colorTag`。
  * 用户进入/离开实时 session 要广播 join/leave 事件。
  * 多人同时选中同一节点时显示多指示（头像/名字）。
* **实时心跳 &丢失恢复**

  * Session 有心跳，超时标记为离线；离线用户的未确认本地 op 应在 reconnect 时提交并由 CRDT 合并。

---

## 四、历史版本、快照、回滚与回放

* **版本策略（业务）**

  * 两级版本：`autosave snapshot`（短周期，例如每 N 次 op 或每 M 分钟）+ `explicit version`（用户手动快照或发布）。
  * 每个 snapshot 存储：chunk 列表 + rootHash + metadata + optional summary（自动或用户填写）。
* **回滚**

  * 回滚到某个 versionId：生成一个新的 operation 集（把当前状态替换为 snapshot 状态），并记录操作来源为 rollback。
  * 回滚前强制权限校验并提示“回滚会覆盖当前未提交的更改，是否确认”。
* **回放模式**

  * 基于 operation log（或 snapshot 差异）逐步还原，每步以 op 为单位回放；支持速度控制（快/慢）和跳到时间点。
* **版本差异对比（diff）**

  * 在业务层比较两个 snapshot 的节点集合与属性差异：新增/删除/更新/移动，返回结构化 diff（用于 UI 高亮）。

---

## 五、文档分片存储与加载策略（业务层）

* **分片单位**：按层级/子树划分（例如以深度为单位或子树节点数阈值）。
* **读取逻辑**

  * 用户打开文档时先加载根 chunk 与最近活跃子 chunk，按需（懒加载）加载子树。
  * 加载 chunk 返回：节点列表 + childrenIndex + versionStamp。
* **写入逻辑**

  * 修改只同步受影响的 chunk。快照也可以是 chunk 级别的 hash 列表。
* **一致性保证**

  * 每个 chunk 有 versionStamp 或 hash，用于检测写入冲突并触发合并/重试逻辑（业务语义描述即可）。

---

## 六、AI 能力（LLM + 模板 + 校验）——业务流程

总体思路：AI 接口是“可插拔业务能力”，每次 AI 调用都走统一 Job 流程（创建 job → 执行 → 校验 → 写入 / 返回结果）。

### A. 从文字生成脑图（Initial generate）

* 触发：用户粘贴/提交一段文本并选择“生成脑图”或指定模板。
* 流程：

  1. **模板选择**（用户选择模板或默认逻辑模板）。
  2. **Prompt 构建**：业务用模板 + docContext（长度/节点数/目标深度）构造 prompt（见“示例 prompt 模板”）。
  3. **LLM 调用**（异步 Job）：生成结构化输出（建议返回 JSON 的节点树：nodeText, labels, suggestedColor）。
  4. **校验**：应用业务校验器（字段长度、标签黑名单、敏感词、循环结构、最大节点数）。
  5. **确认/合并**：若校验通过，返回供用户确认的草稿（preview）或直接插入文档（取决用户设置）。
* 输出：draftNodes（可被用户编辑），jobId 与 cost metadata。

### B. AI 智能扩展某节点（re-expand）

* 触发：用户右键节点 → “智能扩展”
* 流程：

  1. 收集 node 内容与上下文子树（限定深度）。
  2. 构建 prompt（指明目标扩展层级/风格/数量）。
  3. LLM 返回若干子节点建议（结构化）。
  4. 校验并去重（避免重复内容），通过后以 operation 的方式批量插入。
* 业务约束：扩展数量、最大新增节点、并发扩展配额。

### C. AI 自动总结（全局/子树）

* 触发：用户点击“自动总结（全图/子树）”
* 流程：

  1. 提取要总结的节点文本（限定 token 上限）。
  2. 使用“总结模板”（扼要/详细/行动项）调用 LLM。
  3. 返回 summary，并可选择写入文档 meta 或生成孤立 summary 节点。
* 输出：summary 文本 + 可供编辑的 action items（结构化）。

### D. 模板体系与校验（业务）

* **模板**包含：LLM prompt skeleton、期望输出 schema、示例、默认样式。
* **校验器**包含：schema 校验（必须字段）、内容审查（敏感词/长度）、逻辑校验（循环/超深/重复）。
* **失败处理**：若 LLM 返回非法结构，业务层触发重试（N 次）或退回给前端以人工编辑。

---

## 七、导入 / 导出 / 搜索

### 导出

* 格式：PNG / SVG / Markdown / OPML / JSON / 可编辑 PDF（结构化）
* 业务语义：

  * **PNG/SVG**：渲染快照导出（flatten），带页面大小/比例选项。
  * **Markdown/OPML/JSON**：结构化导出，保留节点 id / labels / meta。
  * **可编辑 PDF**：导出包含嵌入结构（如把节点以层级表格写入 PDF metadata 或生成可复制文本），并在 PDF 第一页放图形预览。
* 导出流程：用户请求 → 业务合并当前未保存操作（确保一致视图）→ 触发导出 job → 返回下载链接。

### 导入

* 支持 Markdown / OPML：解析为节点树，校验标签/样式，必要时要求用户映射（比如 Markdown 标题层级映射到树层级）。
* 导入冲突策略：导入到新文档或合并到现有文档（合并时以用户为准，提供 preview diff）。

### 搜索

* 两层搜索：**全局搜索**（跨文档，基于用户权限）与 **文档内节点搜索**（即时，支持标签/内容/属性过滤）。
* 搜索语义：支持模糊匹配、标签过滤、最近修改排序、匹配高亮。
* 搜索结果点击将定位并展开对应 chunk 与节点（若折叠则自动展开）。

---

## 八、离线编辑与自动同步（基于 Yjs CRDT 的业务语义）

* 本地可缓存 operation log；离线时继续记录本地 ops（带 localOpId）。
* 恢复到在线后，上报本地 ops，使用 CRDT 合并（业务层只需保证 op 带 unique id & causality timestamp）。
* 冲突显示策略：当 merge 导致语义冲突（例如同一节点被两人修改），业务层提供“审阅变更”界面（显示两个版本、选择保留）。

---

## 九、快捷键与 UX 交互要点（业务行为）

* Tab：创建并进入子节点（光标 focus 到新节点）。
* Shift+Tab：提升（promote）到兄弟层级。
* Enter：在当前节点下新建兄弟节点并 focus。
* Delete / Backspace（空节点时）：删除节点并 focus 到上一个节点。
* Ctrl/Cmd+Z / Y：撤销/重做（基于 operation log 的 undo stack，业务层保证 undo 是可序列化的）。
* 多选 + 批量操作（标签/颜色）：支持批量修改并生成单一 operation（事务语义）。

---

## 十、模板库与主题

* **模板库业务**：模板可加入市场/私有库，模板带示例/说明/推荐布局。
* **主题/皮肤**：Dark / Classic / Minimal 等；主题只影响样式 meta，不改变节点语义。

---

## 十一、版本差异对比（diff）与回放

* **Diff 输出**：返回 `{added:[], removed:[], updated:[{nodeId, changes}], moved:[{nodeId, from, to}]}`。
* **UI 用例**：高亮差异节点、按作者/时间过滤差异。
* **回放**：以 operation 时间线播放（可按 user filter），支持跳到任意 op。

---

## 十二、防滥用策略（业务级）

* **最小限制原则**：

  * LLM 调用：按用户/组织/文档设置每日/每分钟配额与并发限制，超出拒绝并返回友好提示（含当前配额信息）。
  * IP 限流：基础请求限流阈值（读写分离）。
  * 操作频率控制：例如短时间内大量节点创建触发速率限制或挑战（验证码/二次确认）。
  * 成本控制：在 AI 调用前计算估算 token/cost 并展示给用户，超预算阻止或要求确认。
* **滥用检测**：

  * 校验文本敏感度、禁止生成违法/侵权内容；若 AI 返回疑似违规内容则阻断并标注日志，必要时把请求标记为“需人工审查”。
* **退费/降级策略**：当配额用尽，提供降级：只读/减小输出/压缩调用。

---

## 十三、权限与分享（业务）

* 权限模型：Owner / Editor / Commenter / Viewer。
* 分享链接：两种模式（编辑 / 只读），可选：链接过期时间、密码保护、下载权限控制。
* ACL 变更：owner 修改 ACL 需要记录 audit log，并触发通知（email/webhook）。
* 共享协作场景：多人协作默认开启 presence；匿名编辑（链接编辑）则带匿名 identity。

---

## 十四、异常、边缘与回退策略

* **大文档加载超时**：先加载简化视图（仅标题层级）并提示“继续加载详细内容”。
* **AI 调用失败**：展示可重试理由（网络/配额/内容违规等），并允许人工填充或切换模板。
* **合并冲突无法自动解决**：提示用户进入“冲突审阅模式”并显示两个版本对比。
* **回滚误操作保护**：回滚操作需二次确认；回滚前自动保存当前快照（可撤销）。

---

## 十五、示例业务接口（语义级别，仅说明责任，不含实现细节）

* `POST /documents` → 创建文档（body: title, templateId?）
* `GET /documents/{id}` → 获取文档 meta + root chunk（按权限）
* `POST /documents/{id}/ops` → 提交一批 operation（用于实时/离线提交）
* `GET /documents/{id}/chunks/{chunkId}` → 获取 chunk
* `POST /documents/{id}/ai/generate` → LLM 生成脑图（body: text, templateId, options）返回 jobId & draftNodes
* `POST /ai/jobs/{jobId}/confirm` → 将 draft 写入文档（或返回 editable preview）
* `POST /documents/{id}/snapshot` → 创建 explicit version
* `POST /documents/{id}/rollback` → 回滚到指定 versionId
* `GET /documents/{id}/diff?from=&to=` → 返回差异
* `POST /documents/{id}/export` → 导出请求（body: format, options）返回 downloadUrl
* `POST /share/{documentId}` → 创建分享链接（mode: edit/view, expiry, password）
* `GET /search` → 全局或文档内搜索（query, filters）

---

## 十六、LLM Prompt 模板 示例（业务可直接用）

（注：这些是业务层的 prompt skeleton，实际参数化时把具体 node 内容/上下文填入）

1. **生成脑图（高层结构）**

```
你是一个专注结构化梳理的助手。目标：把以下文本拆解为层级清晰的脑图节点。返回 JSON 数组，每项：
{ "text": "...", "labels": ["..."], "suggestedColor": "...", "children": [...] }
文本：{{user_text}}
目标最大层级：{{max_depth}}，每个父节点最多子节点数：{{max_children}}。不要使用循环引用。若文本含有敏感内容，请标注 "sensitive": true。
```

2. **节点扩展（re-expand）**

```
给定节点文本：{{node_text}}，和其上级上下文（简短）：{{context}}。请生成 3-6 个可落地的子节点，每个子节点一行。返回 JSON: [{ "text":"", "notes": "", "labels": [] }]
```

3. **总结（全图 / 子树）**

```
你要基于以下节点列表做摘要，返回：短摘要（1-2 句），关键结论（要点列表），行动项（可执行、肩负人/优先级）。节点文本：{{node_texts}}。输出 JSON。
```

### 校验规则（业务）

* 结果必须是合法 JSON 且满足 schema。
* 节点总数 <= 预设阈值（避免爆炸）。
* 禁用词检测：若包含则标注并拒绝或截断。

---

## 十七、监控与审计（业务）

* 记录关键事件：文档创建/删除/分享/回滚/大规模 AI 操作/权限修改。
* AI 操作记录成本、输入、输出摘要与校验结果（不必存完整 LLM 输出，除非需要审计）。
* 提供审计视图给 owner / 管理员。

---

## 十八、交付清单（你需要实现的业务要点汇总）

1. 定义数据模型（Document/Node/Chunk/Version/Op/AIJob/Session）。
2. 实现 operation-based 编辑 API（支持幂等 opId）。
3. 实时 session 与 presence 语义（join/leave、cursor、selection）。
4. Snapshot 与 explicit version 管理（autosave + manual）。
5. Chunk 加载/写入语义与分块策略。
6. LLM Job 流程（Prompt模板 → 调用 → 校验 → Draft → 确认写入）。
7. 导入/导出（Markdown/OPML/JSON + PNG/SVG/PDF）。
8. 搜索（文档内与全局）。
9. 回放/差异比较 API（返回结构化 diff）。
10. 离线 op 缓存与同步语义。
11. 权限/分享/ACL 管理与 audit log。
12. 防滥用与配额/限流策略（AI 调用/写入频率/IP/并发）。

---

## 十九、常见 UX 场景与建议（业务提醒）

* AI 生成建议**默认不直接写入**，而是呈现“草稿/建议”供用户接受/编辑/拒绝（除非用户开启“自动合并”）。
* 大规模批量操作要有“预览变更”与“撤销点”。
* 回放/差异需要与版本系统绑定，不建议仅依赖 operation log（日志膨胀）。
* 离线切换时要给出清晰指示（本地变更未同步 / 正在合并）。
* 分享编辑链接要可撤销（owner 能随时禁用）。

