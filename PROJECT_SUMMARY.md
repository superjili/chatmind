## ChatMind 项目总结

该项目旨在打造一个开源、上手即用的脑图编辑器，聚焦“流畅编辑、大文档性能、完整导出与基础协作”。以下为近期关键实现与技术决策总结。

### 近期关键实现
- 文档分片懒加载：小文档（≤100 节点）一次性加载；大文档按需分片加载，双击节点展开未加载子树。
- 操作回放与差异对比：提供操作时间线与版本差异（新增/删除/更新/移动），支持版本快照与回滚。
- 实时协作 UI：在线用户、光标定位、选中高亮，心跳保持与状态同步（无登录态场景也可用）。
- 导入/导出/搜索：支持 Markdown/OPML 导入；Markdown/JSON/OPML/PNG/SVG 导出；全局与文档内搜索。
- 图片导出修复与增强：
  - 统一从 Canvas 导出图片，并提供高分辨率前端内存渲染方案，导出完整脑图。
  - 修复“只导出第一个根节点/仅可视区域”的问题，保证多根与全图导出。
  - 响应拦截器对二进制数据直接返回，避免误解析。
- 导出后端文件流：
  - `ResponseEntity<byte[]>` + 正确的 `Content-Length`、`Content-Disposition`、`Content-Type`。
  - 前端以 `Blob` 下载，文件名从响应头解析。

### 技术决策与原因
- 采用 Canvas 渲染（G6），兼容性与性能较好；图片导出以 Canvas 为基础实现，高分辨率由前端内存渲染保障清晰度。
- 多根节点导出：确保导出内容完整，避免出现头部仅两行的情况。
- 子节点排序按 ID：简化并保证稳定顺序，避免“字符串排序/不可预期顺序”。
- 分片策略：以用户交互为中心，避免初次加载阻塞，按需展开与渲染。

### 代码要点（前端）
- `Editor.vue`
  - `exportHighRes(format)`: 临时放大画布并 `fitView` 全图，导出后恢复视图与尺寸，保证高分辨率与完整性。
  - `request.js`：对 `arraybuffer`/`blob` 直接返回原始响应。
- `MindMapGraph.vue`
  - 自定义节点：文本先渲染并读取 `getBBox()`，矩形尺寸按“文本尺寸 + 内边距”自适应；文本层级在上（`zIndex=1`），矩形在下（`zIndex=0`），并 `group.sort()` 保证绘制顺序。
  - 暴露 `fitView/getGraph`：供父组件在导出时操控画布与视图。

### 代码要点（后端）
- `ExportService`：遍历所有根节点，构建子节点映射并按 ID 排序，导出 Markdown/JSON/OPML；日志包含根/子节点统计与父子关系数量。
- `ExportController`：以文件流返回导出内容，设置 `Content-Disposition` 与 `Content-Type`，并写入 `Content-Length`。

### 待优化方向
- 协作光标定位：结合节点位置信息进一步优化精度。
- 图片导出质量：提供导出分辨率选项（如 4000/6000/8000 像素），以及后续的纯矢量导出方案（需要切换到 SVG 渲染或后端生成矢量）。
- 分片加载体验：增加加载进度与状态展示，提升大图交互反馈。

### 开源建议
- 保持前后端职责边界：导出与下载统一走后端文件流，前端仅负责渲染与交互。
- 提交前确认：改动聚焦、风格一致、说明清晰；尽量避免无关修改。
- 欢迎贡献：Issue/PR 均可，欢迎共同完善分片、协作与导出质量。
